# Generated by nginxconfig.io
user www-data;
pid /run/nginx.pid;
worker_processes auto;
worker_rlimit_nofile 65535;

events {
   multi_accept on;
   worker_connections 65535;
}

http {
   charset utf-8;
   sendfile on;
   tcp_nopush on;
   tcp_nodelay on;
   server_tokens off;
   types_hash_max_size 2048;
   server_names_hash_bucket_size 128;
   server_names_hash_max_size 512;
   client_max_body_size 16M;

   # Limits
   limit_req_log_level warn;
   limit_req_zone  $binary_remote_addr zone=login:10m rate=10r/m;

   # MIME
   include mime.types;
   default_type application/octet-stream;

   # logging
   access_log /var/log/nginx/access.log;
   error_log /var/log/nginx/error.log warn;

   # Compression
   gzip on;
   gzip_comp_level 5;
   gzip_min_length 256;
   gzip_proxied any;
   gzip_types application/javascript application/json application/xml text/css text/plain text/xml application/xml+rss application/grpc+proto;

   include /etc/nginx/conf.d/*.conf;
   include /etc/nginx/sites-enabled/*;

   map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
   }

   upstream vless_grpc {
       server 127.0.0.1:3000;
   }
   upstream vmess_grpc {
       server 127.0.0.1:3100;
   }
   upstream trojan_grpc {
       server 127.0.0.1:3200;
   }
   upstream ss_grpc {
       server 127.0.0.1:3300;
   }
   upstream ss22_grpc {
       server 127.0.0.1:3400;
   }
   server {
       listen 443 http2;
       listen [::]:443 http2;
       server_name _;
       return 400;
   }
   server {
       listen 80 default_server;
       listen 8080 default_server;
       listen 8880 default_server;
       listen 2052 default_server;
       listen 2082 default_server;
       listen 2086 default_server;
       listen 2095 default_server;
       listen [::]:80 default_server;
       listen [::]:8080 default_server;
       listen [::]:8880 default_server;
       listen [::]:2052 default_server;
       listen [::]:2082 default_server;
       listen [::]:2086 default_server;
       listen [::]:2095 default_server;
       listen 443 ssl http2 default_server;
       listen 2053 ssl http2 default_server;
       listen 2083 ssl http2 default_server;
       listen 2087 ssl http2 default_server;
       listen 2096 ssl http2 default_server;
       listen 8443 ssl http2 default_server;
       listen [::]:443 ssl http2 default_server;
       listen [::]:2053 ssl http2 default_server;
       listen [::]:2083 ssl http2 default_server;
       listen [::]:2087 ssl http2 default_server;
       listen [::]:2096 ssl http2 default_server;
       listen [::]:8443 ssl http2 default_server;
       root /var/www/html;
       ssl_certificate /usr/local/etc/xray/fullchain.cer;
       ssl_certificate_key /usr/local/etc/xray/private.key;
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

       # HTTPupgrade Reverse Proxy
       location = /vless-hup {
          proxy_pass http://127.0.0.1:1000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /vmess-hup {
          proxy_pass http://127.0.0.1:1100;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /trojan-hup {
          proxy_pass http://127.0.0.1:1200;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /ss-hup {
          proxy_pass http://127.0.0.1:1300;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /ss22-hup {
          proxy_pass http://127.0.0.1:1400;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }

       # Websocket Reverse Proxy
       location = /vless-ws {
          proxy_pass http://127.0.0.1:2000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /vmess-ws {
          proxy_pass http://127.0.0.1:2100;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /trojan-ws {
          proxy_pass http://127.0.0.1:2200;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /ss-ws {
          proxy_pass http://127.0.0.1:2300;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }
       location = /ss22-ws {
          proxy_pass http://127.0.0.1:2400;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
       }

       # gRPC Reverse Proxy
       location /vless-grpc {
          grpc_pass grpc://vless_grpc;
       }
       location /vmess-grpc {
          grpc_pass grpc://vmess_grpc;
       }
       location /trojan-grpc {
          grpc_pass grpc://trojan_grpc;
       }
       location /ss-grpc {
          grpc_pass grpc://ss_grpc;
       }
       location /ss22-grpc {
          grpc_pass grpc://ss22_grpc;
       }
   }
}